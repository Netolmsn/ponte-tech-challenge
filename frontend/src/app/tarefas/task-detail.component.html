<div class="tarefas-detail-root">
  <div class="tarefas-detail-header flex items-center justify-between mb-3">
    <button
      type="button"
      class="tarefas-detail-back-btn inline-flex items-center gap-1 text-xs text-slate-600 hover:text-indigo-500"
      (click)="voltar()"
    >
      <span class="material-icons text-base">arrow_back</span>
      <span>Voltar para minhas tarefas</span>
    </button>

    <div class="flex items-center gap-2" *ngIf="tarefa">
      <button
        type="button"
        (click)="atribuirTarefa()"
        class="inline-flex items-center gap-1 rounded-full border border-slate-300 bg-white px-3 py-1 text-xs font-medium text-slate-700 hover:bg-slate-50"
      >
        <span class="material-icons text-sm">person_add</span>
        <span>Atribuir</span>
      </button>

      <button
        type="button"
        (click)="toggleFavorito()"
        class="inline-flex items-center gap-1 rounded-full border border-amber-300 bg-amber-50 px-3 py-1 text-xs font-medium text-amber-700 hover:bg-amber-100"
      >
        <span class="material-icons text-sm">
          {{ isFavorite ? 'star' : 'star_border' }}
        </span>
        <span>
          {{
            isFavorite ? 'Remover dos favoritos' : 'Marcar como favorita'
          }}
        </span>
      </button>
    </div>
  </div>

  <div
    *ngIf="!loading && tarefa; else loadingOrError"
    class="tarefas-detail-card bg-white rounded-2xl shadow-sm p-6"
  >
    <div class="space-y-4 mb-4">
      <div>
        <label class="block text-xs font-medium text-slate-600 mb-1">
          Título
        </label>
        <input
          type="text"
          [(ngModel)]="tarefa.titulo"
          class="w-full rounded-lg border border-slate-300 px-3 py-2 text-sm outline-none focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500"
        />
      </div>

      <div>
        <label class="block text-xs font-medium text-slate-600 mb-1">
          Descrição
        </label>
        <textarea
          rows="3"
          [(ngModel)]="tarefa.descricao"
          class="w-full rounded-lg border border-slate-300 px-3 py-2 text-sm outline-none focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500"
        ></textarea>
      </div>

      <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
        <div>
          <label class="block text-xs font-medium text-slate-600 mb-1">
            Status
          </label>
          <select
            [(ngModel)]="tarefa.status"
            class="w-full rounded-lg border border-slate-300 px-3 py-2 text-sm outline-none bg-white focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500"
          >
            <option value="PENDENTE">Pendente</option>
            <option value="EM_ANDAMENTO">Em progresso</option>
            <option value="CONCLUIDA">Concluída</option>
          </select>
        </div>

        <div>
          <label class="block text-xs font-medium text-slate-600 mb-1">
            Prioridade
          </label>
          <select
            [(ngModel)]="tarefa.prioridade"
            class="w-full rounded-lg border border-slate-300 px-3 py-2 text-sm outline-none bg-white focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500"
          >
            <option value="BAIXA">Baixa</option>
            <option value="MEDIA">Média</option>
            <option value="ALTA">Alta</option>
          </select>
        </div>
      </div>

      <div
        class="flex flex-col sm:flex-row items-start sm:items-center justify-between gap-2 text-[11px] text-slate-500"
      >
        <div>
          <p>Criação: {{ tarefa.criado_em | date: 'short' }}</p>
          <p>Atualização: {{ tarefa.atualizado_em | date: 'short' }}</p>
        </div>
        <button
          type="button"
          (click)="salvarTarefa()"
          [disabled]="saving"
          class="inline-flex items-center gap-1 rounded-full bg-indigo-500 px-4 py-1 text-xs font-medium text-white shadow-sm hover:bg-indigo-600 disabled:opacity-60 disabled:cursor-not-allowed"
        >
          <span class="material-icons text-sm">save</span>
          <span>{{ saving ? 'Salvando...' : 'Salvar alterações' }}</span>
        </button>
      </div>
    </div>

    <h3 class="text-xs font-semibold text-slate-500 mb-2">
      Atualizar status rapidamente
    </h3>
    <div class="tarefas-detail-status-actions flex flex-wrap gap-2 mb-4">
      <button
        type="button"
        [disabled]="updating"
        (click)="atualizarStatus('PENDENTE')"
        class="rounded-full border border-slate-300 px-4 py-1 text-xs text-slate-700 hover:bg-slate-50 disabled:opacity-60 disabled:cursor-not-allowed"
      >
        Pendente
      </button>
      <button
        type="button"
        [disabled]="updating"
        (click)="atualizarStatus('EM_ANDAMENTO')"
        class="rounded-full border border-slate-300 px-4 py-1 text-xs text-slate-700 hover:bg-slate-50 disabled:opacity-60 disabled:cursor-not-allowed"
      >
        Em progresso
      </button>
      <button
        type="button"
        [disabled]="updating"
        (click)="atualizarStatus('CONCLUIDA')"
        class="rounded-full border border-indigo-500 bg-indigo-500 px-4 py-1 text-xs font-medium text-white hover:bg-indigo-600 disabled:opacity-60 disabled:cursor-not-allowed"
      >
        Concluída
      </button>
    </div>

    <h3 class="text-xs font-semibold text-slate-500 mb-2">Comentários</h3>
    <div class="space-y-3 mb-4">
      <div class="flex gap-2 items-start">
        <textarea
          rows="2"
          [(ngModel)]="comentarioTexto"
          class="w-full rounded-lg border border-slate-300 px-3 py-2 text-xs outline-none focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500"
          placeholder="Escreva um comentário sobre esta tarefa"
        ></textarea>
        <button
          type="button"
          (click)="adicionarComentario()"
          [disabled]="addingComentario || !comentarioTexto.trim()"
          class="h-9 px-4 rounded-full bg-indigo-500 text-[11px] font-medium text-white shadow-sm hover:bg-indigo-600 disabled:opacity-60 disabled:cursor-not-allowed"
        >
          Comentar
        </button>
      </div>

      <div *ngIf="loadingComentarios" class="text-[11px] text-slate-500">
        Carregando comentários...
      </div>

      <div
        *ngIf="!loadingComentarios && !comentarios.length"
        class="text-[11px] text-slate-400"
      >
        Nenhum comentário ainda. Seja o primeiro a comentar.
      </div>

      <div *ngIf="comentarios.length" class="space-y-2">
        <div
          *ngFor="let comentario of comentarios"
          class="rounded-lg border border-slate-200 bg-slate-50 px-3 py-2"
        >
          <p class="text-xs text-slate-700 mb-1">
            {{ comentario.texto }}
          </p>
          <p class="text-[10px] text-slate-400">
            Criado em: {{ comentario.criado_em | date: 'short' }}
          </p>
        </div>
      </div>
    </div>

    <div class="tarefas-detail-footer flex justify-end">
      <button
        type="button"
        (click)="excluir()"
        class="inline-flex items-center gap-1 rounded-full border border-red-200 px-4 py-1 text-xs font-medium text-red-600 hover:bg-red-50"
      >
        <span class="material-icons text-sm">delete</span>
        <span>Excluir</span>
      </button>
    </div>
  </div>

  <ng-template #loadingOrError>
    <div class="tarefas-detail-card bg-white rounded-2xl shadow-sm p-6">
      <div *ngIf="loading" class="text-sm text-slate-500">
        Carregando tarefa...
      </div>
      <div *ngIf="!loading && error" class="text-sm text-red-500">
        {{ error }}
      </div>
    </div>
  </ng-template>
</div>
