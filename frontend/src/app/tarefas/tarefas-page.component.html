<div class="min-h-screen bg-slate-50">
  <div class="tarefas-root">
    <!-- Header -->
    <div class="mb-6 space-y-1">
      <h1 class="text-2xl font-semibold text-slate-800">Task Dashboard</h1>
      <p class="text-sm text-slate-500">
        Organize, crie e gerencie suas tarefas com eficiência.
      </p>
    </div>

    <!-- Summary card -->
    <div class="tarefas-section p-6 bg-slate-50">
      <ng-container *ngIf="!loadingDashboard; else dashboardLoading">
        <div class="flex flex-wrap gap-4 text-sm text-text-muted mb-4">
          <div>
            <span class="font-semibold text-text-main">Pendentes:</span>
            {{ pendingCount }}
          </div>
          <div>
            <span class="font-semibold text-text-main">Em progresso:</span>
            {{ inProgressCount }}
          </div>
          <div>
            <span class="font-semibold text-text-main">Concluídas:</span>
            {{ completedCount }}
          </div>
        </div>

        <div class="h-52">
          <canvas
            baseChart
            [data]="statusChartData"
            [type]="statusChartType"
            [options]="statusChartOptions"
          ></canvas>
        </div>

        <div class="mt-3 flex flex-wrap gap-4 text-xs text-text-muted">
          <div class="flex items-center gap-1">
            <span class="inline-block w-3 h-3 rounded-sm bg-[#FACC15]"></span>
            <span>Pendente</span>
          </div>
          <div class="flex items-center gap-1">
            <span class="inline-block w-3 h-3 rounded-sm bg-[#3B82F6]"></span>
            <span>Em progresso</span>
          </div>
          <div class="flex items-center gap-1">
            <span class="inline-block w-3 h-3 rounded-sm bg-[#22C55E]"></span>
            <span>Concluída</span>
          </div>
        </div>
      </ng-container>
      <ng-template #dashboardLoading>
        <div class="flex justify-center py-6">
          <div
            class="h-9 w-9 animate-spin rounded-full border-2 border-indigo-500 border-t-transparent"
          ></div>
        </div>
      </ng-template>
    </div>

    <!-- Main grid -->
    <div class="grid grid-cols-1 lg:grid-cols-3 gap-6 mt-6">
      <!-- Left column: filters + form -->
      <div class="lg:col-span-2 space-y-6">
        <!-- Filters card -->
        <div class="tarefas-section p-6">
          <div class="flex items-center gap-2 mb-4">
            <span class="material-icons text-indigo-500 text-xl">tune</span>
            <div>
              <h2 class="text-base font-semibold text-slate-800">Filtros</h2>
              <p class="text-xs text-slate-500">
                Refine suas tarefas por status e prioridade.
              </p>
            </div>
          </div>

          <div class="space-y-4">
            <!-- Filter by status -->
            <div>
              <p class="text-xs font-medium text-slate-500 mb-2">
                Filtrar por status
              </p>
              <div class="flex flex-wrap gap-2">
                <button
                  type="button"
                  class="rounded-full border px-4 py-1 text-xs"
                  [ngClass]="{
                    'bg-indigo-500 text-white border-indigo-500': !filtroStatus,
                    'bg-white text-slate-700 border-slate-200': filtroStatus
                  }"
                  (click)="setStatusFilter(null); setPriorityFilter(null)"
                >
                  Todos os status
                </button>
                <button
                  type="button"
                  class="rounded-full border px-4 py-1 text-xs"
                  [ngClass]="{
                    'bg-indigo-500 text-white border-indigo-500':
                      filtroStatus === 'PENDENTE',
                    'bg-white text-slate-700 border-slate-200':
                      filtroStatus !== 'PENDENTE'
                  }"
                  (click)="setStatusFilter('PENDENTE')"
                >
                  Pendente
                </button>
                <button
                  type="button"
                  class="rounded-full border px-4 py-1 text-xs"
                  [ngClass]="{
                    'bg-indigo-500 text-white border-indigo-500':
                      filtroStatus === 'EM_ANDAMENTO',
                    'bg-white text-slate-700 border-slate-200':
                      filtroStatus !== 'EM_ANDAMENTO'
                  }"
                  (click)="setStatusFilter('EM_ANDAMENTO')"
                >
                  Em progresso
                </button>
                <button
                  type="button"
                  class="rounded-full border px-4 py-1 text-xs"
                  [ngClass]="{
                    'bg-indigo-500 text-white border-indigo-500':
                      filtroStatus === 'CONCLUIDA',
                    'bg-white text-slate-700 border-slate-200':
                      filtroStatus !== 'CONCLUIDA'
                  }"
                  (click)="setStatusFilter('CONCLUIDA')"
                >
                  Concluída
                </button>
              </div>
            </div>

            <!-- Filter by priority -->
            <div>
              <p class="text-xs font-medium text-slate-500 mb-2">
                Filtrar por prioridade
              </p>
              <div class="flex flex-wrap gap-2">
                <button
                  type="button"
                  class="rounded-full border px-4 py-1 text-xs"
                  [ngClass]="{
                    'bg-indigo-500 text-white border-indigo-500':
                      filtroPrioridade === 'ALTA',
                    'bg-white text-slate-700 border-slate-200':
                      filtroPrioridade !== 'ALTA'
                  }"
                  (click)="setPriorityFilter('ALTA')"
                >
                  Alta
                </button>
                <button
                  type="button"
                  class="rounded-full border px-4 py-1 text-xs"
                  [ngClass]="{
                    'bg-indigo-500 text-white border-indigo-500':
                      filtroPrioridade === 'MEDIA',
                    'bg-white text-slate-700 border-slate-200':
                      filtroPrioridade !== 'MEDIA'
                  }"
                  (click)="setPriorityFilter('MEDIA')"
                >
                  Média
                </button>
                <button
                  type="button"
                  class="rounded-full border px-4 py-1 text-xs"
                  [ngClass]="{
                    'bg-indigo-500 text-white border-indigo-500':
                      filtroPrioridade === 'BAIXA',
                    'bg-white text-slate-700 border-slate-200':
                      filtroPrioridade !== 'BAIXA'
                  }"
                  (click)="setPriorityFilter('BAIXA')"
                >
                  Baixa
                </button>
                <button
                  type="button"
                  class="rounded-full border px-4 py-1 text-xs text-slate-700 hover:bg-slate-50"
                  (click)="limparFiltros()"
                >
                  Limpar filtros
                </button>
              </div>
            </div>
          </div>
        </div>

        <!-- Form card -->
        <div class="tarefas-section p-6">
          <div class="flex items-center justify-between mb-4">
            <div>
              <h2 class="text-base font-semibold text-slate-800">
                {{ editingId ? 'Editar tarefa' : 'Nova tarefa' }}
              </h2>
              <p class="text-xs text-slate-500">
                Preencha os campos obrigatórios para salvar a tarefa.
              </p>
            </div>
            <button
              type="button"
              class="text-xs text-slate-500 hover:text-indigo-500"
              (click)="novaTarefa()"
            >
              Nova tarefa
            </button>
          </div>

          <form
            [formGroup]="tarefaForm"
            (ngSubmit)="salvar()"
            class="space-y-4"
          >
            <div class="grid grid-cols-1 gap-4">
              <div>
                <label class="block text-xs font-medium text-slate-600 mb-1">
                  Título *
                </label>
                <input
                  type="text"
                  formControlName="titulo"
                  class="w-full rounded-lg border border-slate-300 px-3 py-2 text-sm outline-none focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500"
                  placeholder="Ex.: Implementar autenticação JWT"
                />
                <div
                  *ngIf="tarefaForm.get('titulo')?.touched && tarefaForm.get('titulo')?.invalid"
                  class="mt-1 text-xs text-red-500"
                >
                  Título deve ter entre 3 e 100 caracteres.
                </div>
              </div>

              <div>
                <label class="block text-xs font-medium text-slate-600 mb-1">
                  Descrição *
                </label>
                <textarea
                  rows="3"
                  formControlName="descricao"
                  class="w-full rounded-lg border border-slate-300 px-3 py-2 text-sm outline-none focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500"
                  placeholder="Detalhe o que precisa ser feito nesta tarefa."
                ></textarea>
                <div
                  *ngIf="tarefaForm.get('descricao')?.touched && tarefaForm.get('descricao')?.invalid"
                  class="mt-1 text-xs text-red-500"
                >
                  Descrição deve ter entre 10 e 500 caracteres.
                </div>
              </div>
            </div>

            <div
              class="grid grid-cols-1 sm:grid-cols-2 gap-4 items-start text-xs"
            >
              <div>
                <label class="block text-xs font-medium text-slate-600 mb-1">
                  Status *
                </label>
                <select
                  formControlName="status"
                  class="w-full rounded-lg border border-slate-300 px-3 py-2 text-sm outline-none bg-white focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500"
                >
                  <option value="PENDENTE">Pendente</option>
                  <option value="EM_ANDAMENTO">Em progresso</option>
                  <option value="CONCLUIDA">Concluída</option>
                </select>
                <div
                  *ngIf="tarefaForm.get('status')?.touched && tarefaForm.get('status')?.invalid"
                  class="mt-1 text-xs text-red-500"
                >
                  Status é obrigatório.
                </div>
              </div>

              <div>
                <label class="block text-xs font-medium text-slate-600 mb-1">
                  Prioridade *
                </label>
                <select
                  formControlName="prioridade"
                  class="w-full rounded-lg border border-slate-300 px-3 py-2 text-sm outline-none bg-white focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500"
                >
                  <option value="BAIXA">Baixa</option>
                  <option value="MEDIA">Média</option>
                  <option value="ALTA">Alta</option>
                </select>
                <div
                  *ngIf="tarefaForm.get('prioridade')?.touched && tarefaForm.get('prioridade')?.invalid"
                  class="mt-1 text-xs text-red-500"
                >
                  Prioridade é obrigatória.
                </div>
              </div>
            </div>

            <div class="pt-2 flex items-center gap-2">
              <button
                type="submit"
                [disabled]="tarefaForm.invalid || saving"
                class="inline-flex items-center justify-center rounded-full bg-indigo-500 px-5 py-2 text-xs font-medium text-white shadow-sm hover:bg-indigo-600 disabled:opacity-60 disabled:cursor-not-allowed transition"
              >
                {{ editingId ? 'Salvar alterações' : 'Criar tarefa' }}
              </button>
              <button
                *ngIf="editingId"
                type="button"
                (click)="cancelarEdicao()"
                class="text-xs text-slate-600 hover:text-slate-800"
              >
                Cancelar
              </button>
              <span
                *ngIf="saving"
                class="text-[11px] text-slate-400 inline-flex items-center gap-1"
              >
                <span
                  class="h-3 w-3 animate-spin rounded-full border border-slate-400 border-t-transparent"
                ></span>
                Salvando...
              </span>
            </div>
          </form>
        </div>
      </div>

      <!-- Right column: task list -->
      <div class="lg:col-span-1">
        <div class="tarefas-section p-6 tarefas-list-card">
          <div class="flex items-center justify-between pb-2">
            <h2 class="text-base font-semibold text-slate-800">
              Minhas tarefas
            </h2>
            <button
              type="button"
              class="text-xs text-slate-500 hover:text-slate-700 inline-flex items-center gap-1"
              (click)="toggleOrdenacao()"
            >
              <span class="material-icons text-sm">sort</span>
              Ordenar por data
            </button>
          </div>

          <div *ngIf="loadingTarefas" class="flex justify-center py-6">
            <div
              class="h-9 w-9 animate-spin rounded-full border-2 border-indigo-500 border-t-transparent"
            ></div>
          </div>

          <div *ngIf="!loadingTarefas && tarefas.length; else semTarefas">
            <div class="space-y-3 max-h-[480px] overflow-auto">
              <div
                *ngFor="let tarefa of tarefas"
                class="rounded-xl border border-slate-100 bg-white px-4 py-3 flex items-start justify-between hover:bg-slate-50 transition"
                [ngClass]="statusClass(tarefa)"
              >
                <div class="mr-3">
                  <div
                    class="flex items-center justify-between gap-2 mb-1 text-xs"
                  >
                    <h3 class="font-semibold text-slate-800 text-sm">
                      {{ tarefa.titulo }}
                    </h3>
                    <span
                      class="inline-flex items-center rounded-full px-2 py-0.5 text-[10px] font-medium"
                      [ngClass]="{
                        'bg-red-100 text-red-700':
                          tarefa.prioridade === 'ALTA',
                        'bg-amber-100 text-amber-700':
                          tarefa.prioridade === 'MEDIA',
                        'bg-emerald-100 text-emerald-700':
                          tarefa.prioridade === 'BAIXA'
                      }"
                    >
                      {{ tarefa.prioridade }}
                    </span>
                  </div>
                  <p class="text-xs text-slate-600 line-clamp-2 mb-1">
                    {{ tarefa.descricao }}
                  </p>
                  <p class="text-[11px] text-slate-400">
                    Criada em: {{ tarefa.criado_em | date: 'short' }}
                  </p>
                </div>

                <div class="flex flex-col gap-1 items-end">
                  <button
                    type="button"
                    (click)="verDetalhes(tarefa)"
                    class="h-7 w-7 inline-flex items-center justify-center rounded-full border border-slate-200 text-slate-500 hover:bg-slate-50 text-[16px]"
                    aria-label="Ver detalhes"
                  >
                    <span class="material-icons text-[16px]">
                      chevron_right
                    </span>
                  </button>
                  <button
                    type="button"
                    (click)="editar(tarefa)"
                    class="h-7 w-7 inline-flex items-center justify-center rounded-full border border-slate-200 text-indigo-500 hover:bg-indigo-50 text-[16px]"
                    aria-label="Editar"
                  >
                    <span class="material-icons text-[16px]">edit</span>
                  </button>
                  <button
                    type="button"
                    (click)="excluir(tarefa)"
                    class="h-7 w-7 inline-flex items-center justify-center rounded-full border border-slate-200 text-red-500 hover:bg-red-50 text-[16px]"
                    aria-label="Excluir"
                  >
                    <span class="material-icons text-[16px]">delete</span>
                  </button>
                </div>
              </div>
            </div>
          </div>

          <ng-template #semTarefas>
            <div
              class="mt-6 flex flex-col items-center justify-center border border-dashed border-slate-200 rounded-xl px-6 py-8 text-center"
            >
              <span class="material-icons mb-2 text-slate-300 text-3xl">
                task_alt
              </span>
              <p class="text-sm font-medium text-slate-700 mb-1">
                Você ainda não possui tarefas.
              </p>
              <p class="text-xs text-slate-500">
                Crie uma nova tarefa no painel ao lado para começar.
              </p>
            </div>
          </ng-template>

          <div
            class="mt-4 flex flex-col sm:flex-row items-center justify-between gap-3 text-xs text-slate-600"
            *ngIf="!loadingTarefas && totalTarefas > 0"
          >
            <div class="flex items-center gap-2">
              <span>Itens por página:</span>
              <select
                class="rounded-md border border-slate-300 bg-white px-2 py-1 text-xs outline-none focus:ring-1 focus:ring-indigo-500 focus:border-indigo-500"
                [value]="pageSize"
                (change)="onPageSizeChange($any($event.target).value)"
              >
                <option *ngFor="let size of pageSizeOptions" [value]="size">
                  {{ size }}
                </option>
              </select>
            </div>
            <div class="flex items-center gap-2">
              <button
                type="button"
                (click)="prevPage()"
                [disabled]="page <= 1"
                class="px-3 py-1 rounded-full border border-slate-300 text-xs hover:bg-slate-50 disabled:opacity-50 disabled:cursor-not-allowed"
              >
                Anterior
              </button>
              <span>
                Página {{ page }} de {{ totalPages }}
              </span>
              <button
                type="button"
                (click)="nextPage()"
                [disabled]="page >= totalPages"
                class="px-3 py-1 rounded-full border border-slate-300 text-xs hover:bg-slate-50 disabled:opacity-50 disabled:cursor-not-allowed"
              >
                Próxima
              </button>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>
